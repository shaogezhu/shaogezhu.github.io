---
title: å¸¸è§çš„é™æµç®—æ³•åˆ†æä»¥åŠæ‰‹å†™å®ç°ï¼ˆè®¡æ•°å™¨ã€æ¼æ–—ã€ä»¤ç‰Œæ¡¶ï¼‰
date: 2021/09/23 22:46:48
categories:
- [Java, æŠ€æœ¯å®è·µ]
tags:
- java
- é™æµç®—æ³•

---

## å¸¸è§çš„é™æµç®—æ³•åˆ†æ

:::primary
é™æµåœ¨æˆ‘ä»¬æ—¥å¸¸ç”Ÿæ´»ä¸­ç»å¸¸è§åˆ°ï¼Œå¦‚**ç«è½¦ç«™é—¨å£çš„æ æ†**ã€**ä¸€äº›æ™¯ç‚¹çš„é—¨ç¥¨åªå‡ºå”®ä¸€å®šçš„æ•°é‡** ç­‰ç­‰ã€‚åœ¨æˆ‘ä»¬çš„å¼€å‘ä¸­ä¹Ÿç”¨åˆ°äº†è¿™ç§æ€æƒ³ã€‚
:::


### ä¸ºä»€ä¹ˆè¦é™æµ
ğŸ«åœ¨ä¿è¯å¯ç”¨çš„æƒ…å†µä¸‹å°½å¯èƒ½å¤šå¢åŠ è¿›å…¥çš„äººæ•°,å…¶ä½™çš„äººåœ¨æ’é˜Ÿç­‰å¾…,æˆ–è€…è¿”å›å‹å¥½æç¤º,ä¿è¯é‡Œé¢çš„è¿›è¡Œç³»ç»Ÿçš„ç”¨æˆ·å¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼Œ **<font color="blue">é˜²æ­¢ç³»ç»Ÿé›ªå´©</font>**ã€‚

### é™æµç®—æ³•
ğŸŒ´ğŸŒ´é™æµç®—æ³•å¾ˆå¤š,å¸¸è§çš„æœ‰ä¸‰ç±»,åˆ†åˆ«æ˜¯ **<font color="purple">è®¡æ•°å™¨ç®—æ³•</font> **ã€**<font color="orange">æ¼æ¡¶ç®—æ³•</font>**ã€**<font color="green">ä»¤ç‰Œæ¡¶ç®—æ³•</font>** ã€‚

> ï¼ˆ1ï¼‰**è®¡æ•°å™¨ï¼š**
>
> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨ä¸€æ®µæ—¶é—´é—´éš”å†…ï¼Œå¤„ç†è¯·æ±‚çš„æœ€å¤§æ•°é‡å›ºå®šï¼Œè¶…è¿‡éƒ¨åˆ†ä¸åšå¤„ç†ã€‚
>
>ï¼ˆ2ï¼‰**æ¼æ¡¶ï¼š**
>
> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ¼æ¡¶å¤§å°å›ºå®šï¼Œå¤„ç†é€Ÿåº¦å›ºå®šï¼Œä½†è¯·æ±‚è¿›å…¥é€Ÿåº¦ä¸å›ºå®šï¼ˆåœ¨çªå‘æƒ…å†µè¯·æ±‚è¿‡å¤šæ—¶ï¼Œä¼šä¸¢å¼ƒè¿‡å¤šçš„è¯·æ±‚ï¼‰ã€‚
>
>ï¼ˆ3ï¼‰**ä»¤ç‰Œæ¡¶ï¼š**
>
> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä»¤ç‰Œæ¡¶çš„å¤§å°å›ºå®šï¼Œä»¤ç‰Œçš„äº§ç”Ÿé€Ÿåº¦å›ºå®šï¼Œä½†æ˜¯æ¶ˆè€—ä»¤ç‰Œï¼ˆå³è¯·æ±‚ï¼‰é€Ÿåº¦ä¸å›ºå®šï¼ˆå¯ä»¥åº”å¯¹ä¸€äº›æŸäº›æ—¶é—´è¯·æ±‚è¿‡å¤šçš„æƒ…å†µï¼‰ï¼›æ¯ä¸ªè¯·æ±‚éƒ½ä¼šä»ä»¤ç‰Œæ¡¶ä¸­å–å‡ºä»¤ç‰Œï¼Œå¦‚æœæ²¡æœ‰ä»¤ç‰Œåˆ™ä¸¢å¼ƒè¯¥æ¬¡è¯·æ±‚ã€‚


### è®¡æ•°å™¨é™æµ

ğŸº**åœ¨ä¸€æ®µæ—¶é—´é—´éš”å†…ï¼Œå¤„ç†è¯·æ±‚çš„æœ€å¤§æ•°é‡å›ºå®šï¼Œè¶…è¿‡éƒ¨åˆ†ä¸åšå¤„ç†ã€‚**

ä¸¾ä¸ªğŸŒ°,æ¯”å¦‚æˆ‘ä»¬è§„å®šå¯¹äºAæ¥å£ï¼Œæˆ‘ä»¬1åˆ†é’Ÿçš„è®¿é—®æ¬¡æ•°ä¸èƒ½è¶…è¿‡100æ¬¡ã€‚

é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è¿™ä¹ˆåšï¼š

ğŸˆåœ¨ä¸€å¼€ å§‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®ä¸€ä¸ªè®¡æ•°å™¨counterï¼Œæ¯å½“ä¸€ä¸ªè¯·æ±‚è¿‡æ¥çš„æ—¶å€™ï¼Œcounterå°±åŠ 1ï¼Œå¦‚æœcounterçš„å€¼å¤§äº100å¹¶ä¸”è¯¥è¯·æ±‚ä¸ç¬¬ä¸€ä¸ªè¯·æ±‚çš„é—´éš”æ—¶é—´è¿˜åœ¨1åˆ†é’Ÿä¹‹å†…ï¼Œé‚£ä¹ˆè¯´æ˜è¯·æ±‚æ•°è¿‡å¤š,æ‹’ç»è®¿é—®ï¼›

ğŸ¬å¦‚æœè¯¥è¯·æ±‚ä¸ç¬¬ä¸€ä¸ªè¯·æ±‚çš„é—´éš”æ—¶é—´å¤§äº1åˆ†é’Ÿï¼Œä¸”counterçš„å€¼è¿˜åœ¨é™æµèŒƒå›´å†…ï¼Œé‚£ä¹ˆå°±é‡ç½® counter,å°±æ˜¯è¿™ä¹ˆç®€å•ç²—æš´ã€‚

![\[å¤–é“¾å›¾ç‰‡è½¬å­˜å¤±è´¥,æºç«™å¯èƒ½æœ‰é˜²ç›—é“¾æœºåˆ¶,å»ºè®®å°†å›¾ç‰‡ä¿å­˜ä¸‹æ¥ç›´æ¥ä¸Šä¼ (img-pkGvVRdd-1647523333397)(/upload/2021/09/image-0cbbc44ec76d446896e989962e8122e5.png)\]](https://img-blog.csdnimg.cn/333bdec3d3524f4c95172376841dd180.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA55Sw5Z-C44CB,size_20,color_FFFFFF,t_70,g_se,x_16)


**ä»£ç å®ç°ï¼š** ğŸ˜
```java
import java.util.concurrent.CountDownLatch;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.atomic.AtomicInteger;
import java.util.concurrent.atomic.AtomicLong;

//è®¡æ•°å™¨ é™æµ
public class CounterLimiter {

    //èµ·å§‹æ—¶é—´
    private static long startTime = System.currentTimeMillis();

    //æ—¶é—´é—´éš”1000ms
    private static long interval = 1000;

    //æ¯ä¸ªæ—¶é—´é—´éš”å†…ï¼Œé™åˆ¶æ•°é‡
    private static long limit = 3;

    //ç´¯åŠ å™¨
    private static AtomicLong accumulator = new AtomicLong();

    /**
     * true ä»£è¡¨æ”¾è¡Œï¼Œè¯·æ±‚å¯å·²é€šè¿‡
     * false ä»£è¡¨é™åˆ¶ï¼Œä¸è®©è¯·æ±‚é€šè¿‡
     */
    public static boolean tryAcquire() {
        long nowTime = System.currentTimeMillis();
        //åˆ¤æ–­æ˜¯å¦åœ¨ä¸Šä¸€ä¸ªæ—¶é—´é—´éš”å†…
        if (nowTime < startTime + interval) {
            //å¦‚æœè¿˜åœ¨ä¸Šä¸ªæ—¶é—´é—´éš”å†…
            long count = accumulator.incrementAndGet();
            if (count <= limit) {
                return true;
            } else {
                return false;
            }
        } else {
            //å¦‚æœä¸åœ¨ä¸Šä¸€ä¸ªæ—¶é—´é—´éš”å†…
            synchronized (CounterLimiter.class) {
                //é˜²æ­¢é‡å¤åˆå§‹åŒ–
                if (nowTime > startTime + interval) {
                    startTime = nowTime;
                    accumulator.set(0);
                }
            }
            //å†æ¬¡è¿›è¡Œåˆ¤æ–­
            long count = accumulator.incrementAndGet();
            if (count <= limit) {
                return true;
            } else {
                return false;
            }
        }
    }


    // æµ‹è¯•
    public static void main(String[] args) {

        //çº¿ç¨‹æ± ï¼Œç”¨äºå¤šçº¿ç¨‹æ¨¡æ‹Ÿæµ‹è¯•
        ExecutorService pool = Executors.newFixedThreadPool(10);
        // è¢«é™åˆ¶çš„æ¬¡æ•°
        AtomicInteger limited = new AtomicInteger(0);
        // çº¿ç¨‹æ•°
        final int threads = 2;
        // æ¯æ¡çº¿ç¨‹çš„æ‰§è¡Œè½®æ•°
        final int turns = 20;
        // åŒæ­¥å™¨
        CountDownLatch countDownLatch = new CountDownLatch(threads);
        long start = System.currentTimeMillis();
        for (int i = 0; i < threads; i++) {
            pool.submit(() ->
            {
                try {

                    for (int j = 0; j < turns; j++) {

                        boolean flag = tryAcquire();
                        if (!flag) {
                            // è¢«é™åˆ¶çš„æ¬¡æ•°ç´¯ç§¯
                            limited.getAndIncrement();
                        }
                        Thread.sleep(200);
                    }

                } catch (Exception e) {
                    e.printStackTrace();
                }
                //ç­‰å¾…æ‰€æœ‰çº¿ç¨‹ç»“æŸ
                countDownLatch.countDown();
            });
        }
        try {
            countDownLatch.await();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        float time = (System.currentTimeMillis() - start) / 1000F;
        //è¾“å‡ºç»Ÿè®¡ç»“æœ
        System.out.println("é™åˆ¶çš„æ¬¡æ•°ä¸ºï¼š" + limited.get() +
                ",é€šè¿‡çš„æ¬¡æ•°ä¸ºï¼š" + (threads * turns - limited.get()));
        System.out.println("é™åˆ¶çš„æ¯”ä¾‹ä¸ºï¼š" + (float) limited.get() / (float) (threads * turns));
        System.out.println("è¿è¡Œçš„æ—¶é•¿ä¸ºï¼š" + time + "s");
    }

}

```
**è®¡æ•°å™¨é™æµçš„ä¸è¶³ï¼š** ğŸŒ´

è¿™ä¸ªç®—æ³•è™½ç„¶ç®€å•ï¼Œä½†æ˜¯å­˜åœ¨**ä¸´ç•Œé—®é¢˜**ï¼Œæˆ‘ä»¬çœ‹ä¸‹å›¾ï¼š

![\[å¤–é“¾å›¾ç‰‡è½¬å­˜å¤±è´¥,æºç«™å¯èƒ½æœ‰é˜²ç›—é“¾æœºåˆ¶,å»ºè®®å°†å›¾ç‰‡ä¿å­˜ä¸‹æ¥ç›´æ¥ä¸Šä¼ (img-xUvgpono-1647523333398)(/upload/2021/09/image-d55d813bbcb544479109dd2248e90ff0.png)\]](https://img-blog.csdnimg.cn/e5b54ef9aa614eab9ada0ab8850d9b1b.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA55Sw5Z-C44CB,size_20,color_FFFFFF,t_70,g_se,x_16)

ğŸ‘‰ğŸ»ä»ä¸Šå›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå‡è®¾æœ‰ä¸€ä¸ªæ¶æ„ç”¨æˆ·ï¼Œä»–åœ¨0:59æ—¶ï¼Œç¬é—´å‘é€äº†100ä¸ªè¯·æ±‚ï¼Œå¹¶ä¸”1:00åˆç¬é—´å‘é€äº†100ä¸ªè¯·æ±‚ï¼Œé‚£ä¹ˆå…¶å®è¿™ä¸ªç”¨æˆ·åœ¨ 1ç§’é‡Œé¢ï¼Œç¬é—´å‘é€äº†200ä¸ªè¯·æ±‚ã€‚

ğŸ¦æˆ‘ä»¬åˆšæ‰è§„å®šçš„æ˜¯1åˆ†é’Ÿæœ€å¤š100ä¸ªè¯·æ±‚ï¼ˆè§„åˆ’çš„ååé‡ï¼‰ï¼Œä¹Ÿå°±æ˜¯æ¯ç§’é’Ÿæœ€å¤š1.7ä¸ªè¯·æ±‚ï¼Œç”¨æˆ·é€šè¿‡åœ¨æ—¶é—´çª—å£çš„é‡ç½®èŠ‚ç‚¹å¤„çªå‘è¯·æ±‚ï¼Œ å¯ä»¥ç¬é—´è¶…è¿‡æˆ‘ä»¬çš„é€Ÿç‡é™åˆ¶ã€‚

ç”¨æˆ·æœ‰å¯èƒ½é€šè¿‡ç®—æ³•çš„è¿™ä¸ªæ¼æ´ï¼Œç¬é—´å‹å®æˆ‘ä»¬çš„åº”ç”¨ã€‚ğŸ™‡ğŸ»â€â™€ï¸

<p><span><span style="font-family:Verdana, Arial, Helvetica, sans-serif;line-height:19px;text-indent:26px;"><span style="font-size:14px;"><span style="font-family:Arial;line-height:26px;"><br></span></span></span></span></p>

<p><span><span style="font-family:Verdana, Arial, Helvetica, sans-serif;line-height:19px;text-indent:26px;"><span style="font-size:14px;"><span style="font-family:Arial;line-height:26px;"><br></span></span></span></span></p>


### æ¼æ¡¶é™æµ
âœ¨æ¼æ¡¶ç®—æ³•é™æµçš„åŸºæœ¬åŸç†ä¸ºï¼š**æ°´ï¼ˆå¯¹åº”è¯·æ±‚ï¼‰ä»è¿›æ°´å£è¿›å…¥åˆ°æ¼æ¡¶é‡Œï¼Œæ¼æ¡¶ä»¥ä¸€å®šçš„é€Ÿåº¦å‡ºæ°´ï¼ˆè¯·æ±‚æ”¾è¡Œï¼‰ï¼Œå½“æ°´æµå…¥é€Ÿåº¦è¿‡å¤§ï¼Œæ¡¶å†…çš„æ€»æ°´é‡å¤§äºæ¡¶å®¹é‡ä¼šç›´æ¥æº¢å‡ºï¼Œè¯·æ±‚è¢«æ‹’ç»ã€‚**
å¤§è‡´çš„æ¼æ¡¶é™æµè§„åˆ™å¦‚ä¸‹ï¼šğŸ“
ï¼ˆ1ï¼‰è¿›æ°´å£ï¼ˆå¯¹åº”å®¢æˆ·ç«¯è¯·æ±‚ï¼‰ä»¥ä»»æ„é€Ÿç‡æµå…¥è¿›å…¥æ¼æ¡¶ã€‚
ï¼ˆ2ï¼‰æ¼æ¡¶çš„å®¹é‡æ˜¯å›ºå®šçš„ï¼Œå‡ºæ°´ï¼ˆæ”¾è¡Œï¼‰é€Ÿç‡ä¹Ÿæ˜¯å›ºå®šçš„ã€‚
ï¼ˆ3ï¼‰æ¼æ¡¶å®¹é‡æ˜¯ä¸å˜çš„ï¼Œå¦‚æœå¤„ç†é€Ÿåº¦å¤ªæ…¢ï¼Œæ¡¶å†…æ°´é‡ä¼šè¶…å‡ºäº†æ¡¶çš„å®¹é‡ï¼Œåˆ™åé¢æµå…¥çš„æ°´æ»´ä¼šæº¢å‡ºï¼Œè¡¨ç¤ºè¯·æ±‚æ‹’ç»ã€‚
![\[å¤–é“¾å›¾ç‰‡è½¬å­˜å¤±è´¥,æºç«™å¯èƒ½æœ‰é˜²ç›—é“¾æœºåˆ¶,å»ºè®®å°†å›¾ç‰‡ä¿å­˜ä¸‹æ¥ç›´æ¥ä¸Šä¼ (img-ohzhfhmz-1647523333399)(/upload/2021/09/image-afa56bce847f4d8b99e2dfd1eb3509aa.png)\]](https://img-blog.csdnimg.cn/27e69fa5f58e45128755cbabf27cc2ed.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA55Sw5Z-C44CB,size_20,color_FFFFFF,t_70,g_se,x_16)


â­æ¼æ¡¶ç®—æ³•å…¶å®å¾ˆç®€å•ï¼Œå¯ä»¥ç²—ç•¥çš„è®¤ä¸ºå°±æ˜¯æ³¨æ°´æ¼æ°´è¿‡ç¨‹ï¼Œå¾€æ¡¶ä¸­ä»¥ä»»æ„é€Ÿç‡æµå…¥æ°´ï¼Œä»¥ä¸€å®šé€Ÿç‡æµå‡ºæ°´ï¼Œå½“æ°´è¶…è¿‡æ¡¶å®¹é‡ï¼ˆcapacityï¼‰åˆ™ä¸¢å¼ƒï¼Œå› ä¸ºæ¡¶å®¹é‡æ˜¯ä¸å˜çš„ï¼Œä¿è¯äº†æ•´ä½“çš„é€Ÿç‡ã€‚

ä»¥ä¸€å®šé€Ÿç‡æµå‡ºæ°´ï¼Œ
![\[å¤–é“¾å›¾ç‰‡è½¬å­˜å¤±è´¥,æºç«™å¯èƒ½æœ‰é˜²ç›—é“¾æœºåˆ¶,å»ºè®®å°†å›¾ç‰‡ä¿å­˜ä¸‹æ¥ç›´æ¥ä¸Šä¼ (img-hFtmsnIH-1647523333399)(/upload/2021/09/image-c7d684d693f74fa5bf4077febb8fccbc.png)\]](https://img-blog.csdnimg.cn/ef3bb3929e4a4e44b34dce33187e672a.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA55Sw5Z-C44CB,size_20,color_FFFFFF,t_70,g_se,x_16)


 **å‰Šå³°ğŸ“ï¼š** æœ‰å¤§é‡æµé‡è¿›å…¥æ—¶,ä¼šå‘ç”Ÿæº¢å‡º,ä»è€Œé™æµä¿æŠ¤æœåŠ¡å¯ç”¨

 **ç¼“å†²ğŸ“ï¼š** ä¸è‡³äºç›´æ¥è¯·æ±‚åˆ°æœåŠ¡å™¨, ç¼“å†²å‹åŠ›

**ä»£ç å®ç°ï¼š** ğŸ˜
~~~java
import java.util.concurrent.CountDownLatch;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.atomic.AtomicInteger;
import java.util.concurrent.atomic.AtomicLong;

//æ¼æ–—é™æµ
public class LeakBucketLimiter {

    //æ¡¶çš„å¤§å°
    private static long capacity = 10;
    //æµå‡ºé€Ÿç‡,æ¯ç§’ä¸¤ä¸ª
    private static long rate = 2;
    //å¼€å§‹æ—¶é—´
    private static long startTime = System.currentTimeMillis();
    //æ¡¶ä¸­å‰©ä½™çš„æ°´
    private static AtomicLong water = new AtomicLong();

    /**
     * true ä»£è¡¨æ”¾è¡Œï¼Œè¯·æ±‚å¯å·²é€šè¿‡
     * false ä»£è¡¨é™åˆ¶ï¼Œä¸è®©è¯·æ±‚é€šè¿‡
     */
    public synchronized static boolean tryAcquire() {
        //å¦‚æœæ¡¶çš„ä½™é‡é—®0ï¼Œç›´æ¥æ”¾è¡Œ
        if (water.get() == 0) {
            startTime = System.currentTimeMillis();
            water.set(1);
            return true;
        }
        //è®¡ç®—ä»å½“å‰æ—¶é—´åˆ°å¼€å§‹æ—¶é—´æµå‡ºçš„æ°´ï¼Œå’Œç°åœ¨æ¡¶ä¸­å‰©ä½™çš„æ°´
        //æ¡¶ä¸­å‰©ä½™çš„æ°´
        water.set(water.get() - (System.currentTimeMillis() - startTime) / 1000 * rate);
        //é˜²æ­¢å‡ºç°<0çš„æƒ…å†µ
        water.set(Math.max(0, water.get()));
        //è®¾ç½®æ–°çš„å¼€å§‹æ—¶é—´
        startTime += (System.currentTimeMillis() - startTime) / 1000 * 1000;
        //å¦‚æœå½“å‰æ°´å°äºå®¹é‡ï¼Œè¡¨ç¤ºå¯ä»¥æ”¾è¡Œ
        if (water.get() < capacity) {
            water.incrementAndGet();
            return true;
        } else {
            return false;
        }
    }


    // æµ‹è¯•
    public static void main(String[] args) {

        //çº¿ç¨‹æ± ï¼Œç”¨äºå¤šçº¿ç¨‹æ¨¡æ‹Ÿæµ‹è¯•
        ExecutorService pool = Executors.newFixedThreadPool(10);
        // è¢«é™åˆ¶çš„æ¬¡æ•°
        AtomicInteger limited = new AtomicInteger(0);
        // çº¿ç¨‹æ•°
        final int threads = 2;
        // æ¯æ¡çº¿ç¨‹çš„æ‰§è¡Œè½®æ•°
        final int turns = 20;
        // åŒæ­¥å™¨
        CountDownLatch countDownLatch = new CountDownLatch(threads);
        long start = System.currentTimeMillis();
        for (int i = 0; i < threads; i++) {
            pool.submit(() ->
            {
                try {

                    for (int j = 0; j < turns; j++) {

                        boolean flag = tryAcquire();
                        if (!flag) {
                            // è¢«é™åˆ¶çš„æ¬¡æ•°ç´¯ç§¯
                            limited.getAndIncrement();
                        }
                        Thread.sleep(200);
                    }

                } catch (Exception e) {
                    e.printStackTrace();
                }
                //ç­‰å¾…æ‰€æœ‰çº¿ç¨‹ç»“æŸ
                countDownLatch.countDown();
            });
        }
        try {
            countDownLatch.await();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        float time = (System.currentTimeMillis() - start) / 1000F;
        //è¾“å‡ºç»Ÿè®¡ç»“æœ
        System.out.println("é™åˆ¶çš„æ¬¡æ•°ä¸ºï¼š" + limited.get() +
                ",é€šè¿‡çš„æ¬¡æ•°ä¸ºï¼š" + (threads * turns - limited.get()));
        System.out.println("é™åˆ¶çš„æ¯”ä¾‹ä¸ºï¼š" + (float) limited.get() / (float) (threads * turns));
        System.out.println("è¿è¡Œçš„æ—¶é•¿ä¸ºï¼š" + time + "s");
    }

}
~~~

**æ¼æ¡¶çš„ä¸è¶³ï¼š** ğŸ¤·â€â™€ï¸
æ¼æ¡¶çš„å‡ºæ°´é€Ÿåº¦å›ºå®šï¼Œä¹Ÿå°±æ˜¯è¯·æ±‚æ”¾è¡Œé€Ÿåº¦æ˜¯å›ºå®šçš„ã€‚
æ¼æ¡¶å‡ºå£çš„é€Ÿåº¦å›ºå®šï¼Œä¸èƒ½çµæ´»çš„åº”å¯¹åç«¯èƒ½åŠ›æå‡ã€‚æ¯”å¦‚ï¼Œé€šè¿‡åŠ¨æ€æ‰©å®¹ï¼Œåç«¯æµé‡ä»1000QPSæå‡åˆ°1WQPSï¼Œæ¼æ¡¶æ²¡æœ‰åŠæ³•ã€‚


<p><span><span style="font-family:Verdana, Arial, Helvetica, sans-serif;line-height:19px;text-indent:26px;"><span style="font-size:14px;"><span style="font-family:Arial;line-height:26px;"><br></span></span></span></span></p>

<p><span><span style="font-family:Verdana, Arial, Helvetica, sans-serif;line-height:19px;text-indent:26px;"><span style="font-size:14px;"><span style="font-family:Arial;line-height:26px;"><br></span></span></span></span></p>

### ä»¤ç‰Œæ¡¶é™æµ
**ğŸ¬ä»¤ç‰Œæ¡¶ç®—æ³•ä¸­æ–°è¯·æ±‚åˆ°æ¥æ—¶ä¼šä»æ¡¶é‡Œæ‹¿èµ°ä¸€ä¸ªä»¤ç‰Œï¼Œå¦‚æœæ¡¶å†…æ²¡æœ‰ä»¤ç‰Œå¯æ‹¿ï¼Œå°±æ‹’ç»æœåŠ¡ã€‚**  å½“ç„¶ï¼Œä»¤ç‰Œçš„æ•°é‡ä¹Ÿæ˜¯æœ‰ä¸Šé™çš„ã€‚ä»¤ç‰Œçš„æ•°é‡ä¸æ—¶é—´å’Œå‘æ”¾é€Ÿç‡å¼ºç›¸å…³ï¼Œæ—¶é—´æµé€çš„æ—¶é—´è¶Šé•¿ï¼Œä¼šä¸æ–­å¾€æ¡¶é‡ŒåŠ å…¥è¶Šå¤šçš„ä»¤ç‰Œï¼Œå¦‚æœä»¤ç‰Œå‘æ”¾çš„é€Ÿåº¦æ¯”ç”³è¯·é€Ÿåº¦å¿«ï¼Œä»¤ç‰Œæ¡¶ä¼šæ”¾æ»¡ä»¤ç‰Œï¼Œç›´åˆ°ä»¤ç‰Œå æ»¡æ•´ä¸ªä»¤ç‰Œæ¡¶ã€‚

ä»¤ç‰Œæ¡¶é™æµå¤§è‡´çš„è§„åˆ™å¦‚ä¸‹ï¼šğŸ™‡ğŸ»â€
ï¼ˆ1ï¼‰è¿›æ°´å£æŒ‰ç…§æŸä¸ªé€Ÿåº¦ï¼Œå‘æ¡¶ä¸­æ”¾å…¥ä»¤ç‰Œã€‚
ï¼ˆ2ï¼‰ä»¤ç‰Œçš„å®¹é‡æ˜¯å›ºå®šçš„ï¼Œä½†æ˜¯æ”¾è¡Œçš„é€Ÿåº¦ä¸æ˜¯å›ºå®šçš„ï¼Œåªè¦æ¡¶ä¸­è¿˜æœ‰å‰©ä½™ä»¤ç‰Œï¼Œä¸€æ—¦è¯·æ±‚è¿‡æ¥å°±èƒ½ç”³è¯·æˆåŠŸï¼Œç„¶åæ”¾è¡Œã€‚
ï¼ˆ3ï¼‰å¦‚æœä»¤ç‰Œçš„å‘æ”¾é€Ÿåº¦ï¼Œæ…¢äºè¯·æ±‚åˆ°æ¥é€Ÿåº¦ï¼Œæ¡¶å†…å°±æ— ç‰Œå¯é¢†ï¼Œè¯·æ±‚å°±ä¼šè¢«æ‹’ç»ã€‚

æ€»ä¹‹ï¼Œä»¤ç‰Œçš„å‘é€é€Ÿç‡å¯ä»¥è®¾ç½®ï¼Œä»è€Œå¯ä»¥å¯¹çªå‘çš„å‡ºå£æµé‡è¿›è¡Œæœ‰æ•ˆçš„åº”å¯¹ã€‚
![\[å¤–é“¾å›¾ç‰‡è½¬å­˜å¤±è´¥,æºç«™å¯èƒ½æœ‰é˜²ç›—é“¾æœºåˆ¶,å»ºè®®å°†å›¾ç‰‡ä¿å­˜ä¸‹æ¥ç›´æ¥ä¸Šä¼ (img-OlS9VCnB-1647523333401)(/upload/2021/09/image-f5b402eae3b2409c8939b34d8be41f9c.png)\]](https://img-blog.csdnimg.cn/04bc89a81781443aa1e0bfb07260ab58.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA55Sw5Z-C44CB,size_20,color_FFFFFF,t_70,g_se,x_16)






**ä»£ç å®ç°ï¼š** ğŸ˜
~~~java
import java.util.concurrent.CountDownLatch;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.atomic.AtomicInteger;
import java.util.concurrent.atomic.AtomicLong;

//ä»¤ç‰Œæ¡¶
public class TokenBucketLimiter {
    //æ¡¶çš„å®¹é‡
    private static long capacity = 10;
    //æ”¾å…¥ä»¤ç‰Œçš„é€Ÿç‡,æ¯ç§’2ä¸ª
    private static long rate = 2;
    //ä¸Šæ¬¡æ”¾ç½®ä»¤ç‰Œçš„æ—¶é—´
    private static long lastTime = System.currentTimeMillis();
    //æ¡¶ä¸­ä»¤ç‰Œçš„ä½™é‡
    private static AtomicLong tokenNum = new AtomicLong();

    /**
     * true ä»£è¡¨æ”¾è¡Œï¼Œè¯·æ±‚å¯å·²é€šè¿‡
     * false ä»£è¡¨é™åˆ¶ï¼Œä¸è®©è¯·æ±‚é€šè¿‡
     */
    public synchronized static boolean tryAcquire() {
        //æ›´æ–°æ¡¶ä¸­å‰©ä½™ä»¤ç‰Œçš„æ•°é‡
        long now = System.currentTimeMillis();
        tokenNum.addAndGet((now - lastTime) / 1000 * rate);
        tokenNum.set(Math.min(capacity, tokenNum.get()));
        //æ›´æ–°æ—¶é—´
        lastTime += (now - lastTime) / 1000 * 1000;
        //æ¡¶ä¸­è¿˜æœ‰ä»¤ç‰Œå°±æ”¾è¡Œ
        if (tokenNum.get() > 0) {
            tokenNum.decrementAndGet();
            return true;
        } else {
            return false;
        }
    }


    //æµ‹è¯•
    public static void main(String[] args) {

        //çº¿ç¨‹æ± ï¼Œç”¨äºå¤šçº¿ç¨‹æ¨¡æ‹Ÿæµ‹è¯•
        ExecutorService pool = Executors.newFixedThreadPool(10);
        // è¢«é™åˆ¶çš„æ¬¡æ•°
        AtomicInteger limited = new AtomicInteger(0);
        // çº¿ç¨‹æ•°
        final int threads = 2;
        // æ¯æ¡çº¿ç¨‹çš„æ‰§è¡Œè½®æ•°
        final int turns = 20;
        // åŒæ­¥å™¨
        CountDownLatch countDownLatch = new CountDownLatch(threads);
        long start = System.currentTimeMillis();
        for (int i = 0; i < threads; i++) {
            pool.submit(() ->
            {
                try {

                    for (int j = 0; j < turns; j++) {

                        boolean flag = tryAcquire();
                        if (!flag) {
                            // è¢«é™åˆ¶çš„æ¬¡æ•°ç´¯ç§¯
                            limited.getAndIncrement();
                        }
                        Thread.sleep(200);
                    }

                } catch (Exception e) {
                    e.printStackTrace();
                }
                //ç­‰å¾…æ‰€æœ‰çº¿ç¨‹ç»“æŸ
                countDownLatch.countDown();
            });
        }
        try {
            countDownLatch.await();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        float time = (System.currentTimeMillis() - start) / 1000F;
        //è¾“å‡ºç»Ÿè®¡ç»“æœ
        System.out.println("é™åˆ¶çš„æ¬¡æ•°ä¸ºï¼š" + limited.get() +
                ",é€šè¿‡çš„æ¬¡æ•°ä¸ºï¼š" + (threads * turns - limited.get()));
        System.out.println("é™åˆ¶çš„æ¯”ä¾‹ä¸ºï¼š" + (float) limited.get() / (float) (threads * turns));
        System.out.println("è¿è¡Œçš„æ—¶é•¿ä¸ºï¼š" + time + "s");
    }

}
~~~


**ä»¤ç‰Œæ¡¶çš„å¥½å¤„ï¼š** ğŸš€ğŸš€ğŸš€
ä»¤ç‰Œæ¡¶çš„å¥½å¤„ä¹‹ä¸€å°±æ˜¯å¯ä»¥æ–¹ä¾¿åœ°åº”å¯¹ çªå‘å‡ºå£æµé‡ï¼ˆåç«¯èƒ½åŠ›çš„æå‡ï¼‰ã€‚

æ¯”å¦‚ï¼Œå¯ä»¥æ”¹å˜ä»¤ç‰Œçš„å‘æ”¾é€Ÿåº¦ï¼Œç®—æ³•èƒ½æŒ‰ç…§æ–°çš„å‘é€é€Ÿç‡è°ƒå¤§ä»¤ç‰Œçš„å‘æ”¾æ•°é‡ï¼Œä½¿å¾—å‡ºå£çªå‘æµé‡èƒ½è¢«å¤„ç†ã€‚

